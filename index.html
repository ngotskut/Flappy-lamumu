<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flappy Lamumu üêÆ</title>
  <style>
    :root { --bg:#7a9598; --panel:#ffffff; --muted:#8aa0a3; --accent:#1570ef; --shadow:0 10px 30px rgba(0,0,0,.15); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    #hud{position:fixed;top:8px;left:0;right:0;text-align:center;color:#000;font-weight:700}
    canvas{display:block;margin:0 auto;background:linear-gradient(#9fe8ff,#bfefff) no-repeat center/cover;box-shadow:var(--shadow);border-radius:18px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center}
    .card{width:min(720px,96vw);background:var(--panel);padding:24px;border-radius:20px;box-shadow:var(--shadow)}
    .title{font-weight:800;font-size:clamp(20px,2.8vw,28px);text-align:center;margin:0 0 8px}
    .sub{color:#4b5563;text-align:center;margin:0 0 20px}
    .name{display:block;width:100%;max-width:360px;margin:0 auto 16px;padding:10px 14px;border:1.5px solid #d1d5db;border-radius:12px;outline:none}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;margin:10px 0 14px}
    .slot{border:1.5px solid #e5e7eb;border-radius:16px;padding:14px;text-align:center}
    .slot img{width:80px;height:80px;object-fit:contain;display:block;margin:4px auto 10px}
    .row{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:8px}
    button{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn{background:#eef2ff;color:#111827}
    .btn.primary{background:var(--accent);color:white}
    #flapBtn{position:fixed;left:50%;transform:translateX(-50%);bottom:12px}
    /* leaderboard */
    #lbList{max-height:50vh;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px}
    #lbList li{display:flex;justify-content:space-between;padding:8px 10px;border-bottom:1px dashed #eee}
    #lbList li span:first-child{opacity:.75}
  </style>
</head>
<body>

  <div id="hud">Score: <span id="scoreTxt">0</span></div>
  <canvas id="game" width="420" height="720"></canvas>

  <!-- START MODAL -->
  <div class="modal" id="startModal">
    <div class="card">
      <h1 class="title">Flappy Lamumu üêÆ</h1>
      <p class="sub">Tap / Click / Space to flap ‚Ä¢ Press C to switch character quickly</p>

      <input id="playerName" class="name" placeholder="Enter your name" />

      <div class="grid" id="charGrid">
        <!-- 4 pilihan karakter akan diisi oleh JS -->
      </div>

      <div class="row">
        <button class="btn" id="leaderboardBtn">Leaderboard</button>
        <button class="btn primary" id="startBtn">Start</button>
      </div>

      <!-- panel leaderboard -->
      <div id="lbPanel" style="display:none;margin-top:16px">
        <h3 style="margin:8px 0 6px">Top 100 Leaderboard</h3>
        <ol id="lbList"></ol>
      </div>
    </div>
  </div>

  <button id="flapBtn" class="btn">Flap</button>

  <!-- AUDIO (pastikan file ada di /assets) -->
  <audio id="bgm" src="assets/sweet-country-farm-music-full-354815.mp3" loop></audio>
  <audio id="sfxOver" src="assets/cow-moo-390282.mp3"></audio>

  <script>
  // ========= helpers =========
  const $ = (s,root=document)=>root.querySelector(s);
  const onTap = (el, fn) => el && ['click','touchstart'].forEach(ev => el.addEventListener(ev, e => { e.preventDefault(); fn(e); }, {passive:false}));

  // coba muat path yang tersedia (lowercase/Uppercase)
  function pickSpritePath(n){
    const lower = `assets/lamumu${n}.png`;
    const upper = `assets/Lamumu${n}.png`;
    return new Promise(resolve=>{
      const test = new Image();
      test.onload = ()=> resolve(lower);
      test.onerror = ()=>{
        const t2 = new Image();
        t2.onload = ()=> resolve(upper);
        t2.onerror = ()=> resolve(lower); // fallback
        t2.src = upper;
      };
      test.src = lower;
    });
  }

  // ========== UI & State ==========
  const cvs = $('#game'), ctx = cvs.getContext('2d');
  const scoreTxt = $('#scoreTxt');
  const startModal = $('#startModal');
  const nameInput = $('#playerName');
  const lbPanel = $('#lbPanel');
  const lbList = $('#lbList');
  const flapBtn = $('#flapBtn');

  const bgm = $('#bgm');
  const sfxOver = $('#sfxOver');

  let GAME = { running:false, score:0, name:'', bird:{x:120,y:320,vy:0,img:null}, pipes:[], spriteIndex:1, gravity:0.45, flapV:-7 };

  // buat kartu karakter
  async function renderCharacterGrid(){
    const grid = $('#charGrid');
    grid.innerHTML = '';
    for(let i=1;i<=4;i++){
      const wrap = document.createElement('div'); wrap.className='slot';
      const img = document.createElement('img'); img.alt=`Lamumu #${i}`; img.src = await pickSpritePath(i);
      const label = document.createElement('div'); label.textContent = `Lamumu #${i}`;
      const radWrap = document.createElement('label'); radWrap.style.display='inline-flex'; radWrap.style.alignItems='center'; radWrap.style.gap='6px';
      const rad = document.createElement('input'); rad.type='radio'; rad.name='lamu'; rad.value=i; if(i===1) rad.checked=true;
      const txt = document.createElement('span'); txt.textContent=`Use #${i}`;
      radWrap.append(rad, txt);
      wrap.append(img,label,radWrap);
      grid.append(wrap);
    }
  }

  // audio unlock (mobile)
  const unlockAudio = () => {
    [bgm,sfxOver].forEach(a=>{
      try { a.muted=false; a.play().then(()=>a.pause()).catch(()=>{}); } catch(e){}
    });
    window.removeEventListener('touchstart', unlockAudio);
    window.removeEventListener('click', unlockAudio);
  };
  window.addEventListener('touchstart', unlockAudio, { once:true });
  window.addEventListener('click', unlockAudio, { once:true });

  // ========= Game core (simple flappy) =========
  function resetGame(){
    GAME.score = 0; scoreTxt.textContent = 0;
    GAME.bird.y = cvs.height/2; GAME.bird.vy = 0;
    GAME.pipes = [{x:480,h:200,gap:150},{x:760,h:220,gap:150},{x:1040,h:180,gap:150}];
  }

  function flap(){ if(!GAME.running) return; GAME.bird.vy = GAME.flapV; }
  function spawnPipe(){
    const h = 140 + Math.random()*160;
    GAME.pipes.push({x:cvs.width+120,h, gap:150});
  }

  function update(){
    if(!GAME.running) return;
    // physics
    GAME.bird.vy += GAME.gravity;
    GAME.bird.y += GAME.bird.vy;

    // pipes
    for(const p of GAME.pipes){ p.x -= 2.4; }
    if(GAME.pipes[0].x < -80) GAME.pipes.shift();
    if(GAME.pipes[GAME.pipes.length-1].x < cvs.width-260) spawnPipe();

    // collision & score
    for(const p of GAME.pipes){
      const topBot = p.h, gap = p.gap;
      // rectangle checks
      const bx = GAME.bird.x, by = GAME.bird.y, bw=40,bh=32;
      const inPipeX = bx+bw>p.x && bx<p.x+70;
      const hitTop = by < topBot- gap/2;
      const hitBot = by+bh > topBot + gap/2;
      if(inPipeX && (hitTop || hitBot)){ return gameOver(); }
      if(p.x+70 < bx && !p.passed){ p.passed=true; score(1); }
    }

    // ground / ceiling
    if(GAME.bird.y<0 || GAME.bird.y>cvs.height-40){ return gameOver(); }

    draw();
    requestAnimationFrame(update);
  }

  function draw(){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    // pipes
    ctx.fillStyle='#1d4ed8';
    for(const p of GAME.pipes){
      // top
      ctx.fillRect(p.x, 0, 70, p.h - p.gap/2);
      // bottom
      ctx.fillRect(p.x, p.h + p.gap/2, 70, cvs.height-(p.h+p.gap/2));
    }
    // bird
    if(GAME.bird.img){
      ctx.drawImage(GAME.bird.img, GAME.bird.x, GAME.bird.y, 40, 40);
    }else{
      ctx.fillStyle='#222'; ctx.fillRect(GAME.bird.x, GAME.bird.y, 40, 32);
    }
  }

  function score(n){ GAME.score+=n; scoreTxt.textContent = GAME.score; }

  async function startGame(){
    // ambil nama & karakter
    const name = nameInput.value.trim();
    if(!name){ alert('Please enter your name'); return; }
    const cho = document.querySelector('input[name="lamu"]:checked'); 
    const idx = cho ? Number(cho.value) : 1;
    GAME.name = name; GAME.spriteIndex = idx;

    // muat sprite
    const src = await pickSpritePath(idx);
    const img = new Image(); img.src = src; await img.decode().catch(()=>{});
    GAME.bird.img = img;

    // mulai
    startModal.style.display='none';
    bgm.currentTime=0; bgm.volume=.35; bgm.play().catch(()=>{});
    GAME.running = true; resetGame(); draw(); update();
  }

  async function gameOver(){
    GAME.running = false;
    bgm.pause(); sfxOver.currentTime=0; sfxOver.play().catch(()=>{});
    // submit skor
    try{
      await fetch('/api/leaderboard/submit', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name: GAME.name || 'anon', score: GAME.score })
      });
    }catch(_){}
    // balik ke menu
    setTimeout(()=>{ startModal.style.display='grid'; }, 600);
  }

  // ========= Leaderboard =========
  async function openLeaderboard(){
    lbPanel.style.display='block';
    lbList.innerHTML = '<li>Loading‚Ä¶</li>';
    try{
      const res = await fetch('/api/leaderboard/top');
      const json = await res.json();
      if(!json.ok) throw new Error('Failed');
      lbList.innerHTML = '';
      (json.entries || []).forEach((e,i)=>{
        const li = document.createElement('li');
        const rank = String(i+1).padStart(2,'0');
        li.innerHTML = `<span>#${rank}</span> <b>${e.name || 'anon'}</b> <span>${e.score}</span>`;
        lbList.append(li);
      });
      if(!json.entries || json.entries.length===0){
        lbList.innerHTML = '<li>No scores yet. Be the first!</li>';
      }
    }catch(err){
      lbList.innerHTML = '<li>Cannot load leaderboard.</li>';
    }
  }

  // ========= bind UI =========
  window.addEventListener('DOMContentLoaded', async ()=>{
    await renderCharacterGrid();
    onTap($('#startBtn'), startGame);
    onTap($('#leaderboardBtn'), openLeaderboard);
    onTap(flapBtn, flap);
    // tap/click canvas utk flap
    onTap(cvs, flap);
    // keyboard
    window.addEventListener('keydown', (e)=>{
      if(e.code==='Space') { e.preventDefault(); flap(); }
      if(e.key.toLowerCase()==='c'){
        // quick switch character
        const next = ((GAME.spriteIndex||1) % 4) + 1;
        const radio = document.querySelector(`input[name="lamu"][value="${next}"]`);
        if(radio) radio.checked = true;
        GAME.spriteIndex = next;
      }
    });
  });
  </script>
</body>
</html>
