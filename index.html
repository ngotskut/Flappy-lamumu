<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Flappy Lamumu</title>
<style>
  *,*::before,*::after{ box-sizing:border-box }
  :root{ --ui-bg:rgba(255,255,255,.96); --ui-radius:18px; --brand:#2563eb; }
  html,body{height:100%;margin:0}
  body{background:#6b8f99;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow:hidden}
  #wrap{position:fixed;inset:0}
  #game{position:absolute;inset:0;display:block;background:linear-gradient(#cfefff,#bde6fd)}
  #score{
    position:absolute;top:8px;left:50%;transform:translateX(-50%);
    font-weight:700;font-size:16px;pointer-events:none;
    color:#0b1222;text-shadow:0 1px 2px rgba(255,255,255,.25);
  }

  /* overlay & start panel */
  #overlay{position:absolute;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:8}
  #startPanel{
    width:min(680px,92vw);background:var(--ui-bg);backdrop-filter:saturate(1.2) blur(8px);
    border-radius:var(--ui-radius);box-shadow:0 20px 60px rgba(0,0,0,.35);padding:22px 20px;z-index:9;text-align:center;
  }
  #startPanel h2{margin:6px 0 8px;font-size:22px}
  .muted{color:#4b5563;font-size:12px}

  /* slider karakter */
  #charRow{
    display:flex; gap:12px; align-items:stretch;
    overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-behavior:smooth;
    padding-bottom:4px; margin-top:10px;
  }
  #charRow::-webkit-scrollbar{height:0}
  #charRow{scrollbar-width:none}
  .card{flex:0 0 160px;border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px 12px;text-align:center;background:#fff}
  .card img{width:72px;height:72px;object-fit:contain;display:block;margin:4px auto 8px}
  #startPanel .card .muted{display:none!important}
  #startPanel .card div:last-child{font-size:0;line-height:1}
  #startPanel .card div:last-child input[type="radio"]{transform:scale(1.35);vertical-align:middle}

  .actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
  .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:600;background:#e5e7eb;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff}
  .btn[disabled]{opacity:.45;cursor:not-allowed}

  input[type="text"]{width:100%;max-width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:14px}
  input[type="text"].invalid{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.15)}
  #nameErr{display:none;color:#ef4444;font-size:12px;margin-top:6px}

  /* leaderboard table */
  #lbPanel h3{font-size:16px}
  #lbList table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px}
  #lbList thead th,#lbList tbody td{padding:10px 14px;border-bottom:1px solid #eef2f7;vertical-align:middle;white-space:nowrap;}
  #lbList thead th:nth-child(1),#lbList tbody td:nth-child(1){width:52px;text-align:center}
  #lbList thead th:nth-child(2),#lbList tbody td:nth-child(2){width:auto;text-align:left}
  #lbList thead th:nth-child(3),#lbList tbody td:nth-child(3){width:96px;text-align:right;font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1,"lnum" 1;}
  #lbList thead th{background:#f6f8fb;font-weight:700}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>
  <div id="score">Score: 0</div>

  <div id="overlay">
    <div id="startPanel">
      <h2>Flappy Lamumu üêÆ</h2>
      <div class="muted">Tap / Click anywhere on the game to flap ¬∑ Press <b>C</b> to switch character quickly</div>

      <div style="margin:12px 0 6px">
        <input id="playerName" type="text" placeholder="Enter your name (required for leaderboard)">
        <div id="nameErr">Please enter at least 3 characters.</div>
      </div>

      <div id="charRow" aria-label="Choose character">
        <label class="card"><img src="assets/lamumu1.png" alt="Lamumu 1"><div><input type="radio" name="char" value="0" checked></div></label>
        <label class="card"><img src="assets/lamumu2.png" alt="Lamumu 2"><div><input type="radio" name="char" value="1"></div></label>
        <label class="card"><img src="assets/lamumu3.png" alt="Lamumu 3"><div><input type="radio" name="char" value="2"></div></label>
        <label class="card"><img src="assets/lamumu4.png" alt="Lamumu 4"><div><input type="radio" name="char" value="3"></div></label>
      </div>

      <div class="actions">
        <button id="btnStart" class="btn primary" disabled>Start</button>
        <button id="btnLb" class="btn" type="button">Leaderboard</button>
      </div>
      <div class="muted" style="text-align:center;margin-top:6px">Tip: You can change character during play by pressing <b>C</b>.</div>
    </div>
  </div>

  <!-- optional audio; aman jika file tidak ada -->
  <audio id="bgm" src="assets/sweet-country-farm-music-full-354815.mp3" loop preload="auto"></audio>
  <audio id="moo" src="assets/cow-moo-390282.mp3" preload="auto"></audio>
</div>

<script>
(() => {
/* ================== UTIL & SETUP UMUM ================== */
const CHAR_SRCS=['assets/lamumu1.png','assets/lamumu2.png','assets/lamumu3.png','assets/lamumu4.png'];
const BONUS_SRC='assets/bonus.png';

const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const scoreEl=document.getElementById('score');
const overlay=document.getElementById('overlay');
const btnStart=document.getElementById('btnStart');
const nameInput=document.getElementById('playerName');
const nameErr=document.getElementById('nameErr');

const startPanel=document.getElementById('startPanel');
const btnLb=document.getElementById('btnLb');
const lbPanel=document.createElement('div');
lbPanel.id='lbPanel'; lbPanel.style.marginTop='14px'; lbPanel.style.display='none';
lbPanel.innerHTML=`<h3 style="margin:0 0 8px">Top 100 Leaderboard</h3>
<div id="lbList" style="max-height:240px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff"><div class="muted" style="padding:10px">Loading‚Ä¶</div></div>`;
startPanel.appendChild(lbPanel);
const lbList=lbPanel.querySelector('#lbList');

nameInput.value=localStorage.getItem('lamumu_name')||'';
const MIN_NAME=3;
function validateName(){
  const ok=(nameInput.value.trim().length>=MIN_NAME);
  btnStart.disabled=!ok; nameInput.classList.toggle('invalid',!ok);
  nameErr.style.display=ok?'none':'block'; return ok;
}
nameInput.addEventListener('input',validateName);
nameInput.addEventListener('blur',validateName);
validateName();

let W=0,H=0,DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
function resize(){ W=innerWidth|0; H=innerHeight|0;
  canvas.width=(W*DPR)|0; canvas.height=(H*DPR)|0; canvas.style.width=W+'px'; canvas.style.height=H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize',resize,{passive:true}); resize();

/* ===== Utilities warna & easing ===== */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>a+Math.random()*(b-a);
function hexToRgb(h){const p=n=>parseInt(n,16); return [p(h.slice(1,3)),p(h.slice(3,5)),p(h.slice(5,7))];}
function mixColor(h1,h2,t){const [r1,g1,b1]=hexToRgb(h1),[r2,g2,b2]=hexToRgb(h2);const r=(r1+(r2-r1)*t)|0,g=(g1+(g2-g1)*t)|0,b=(b1+(b2-b1)*t)|0;return `rgb(${r},${g},${b})`;}
function smooth01(t){return t*t*(3-2*t);} // smoothstep 0..1
function remapSmooth(x,a,b){return smooth01(clamp((x-a)/(b-a),0,1));}

/* ================== PHYSICS & STATE ================== */
const state={running:false, score:0, time:0, speedBase:190, speedMax:420, speed:190, pipesPassed:0, speedPerPipe:2.2, gravity:900, flapVel:-400, charIndex:0};
const pipes=[];
const bonuses=[];
const player={ x:Math.max(80,(W*0.18)|0), y:(H*0.45)|0, vy:0, r:Math.max(22,(Math.min(W,H)*0.024)|0), sprite:null };

const charImgs=CHAR_SRCS.map(s=>{const im=new Image(); im.src=s; return im;});
const bonusImg=new Image(); bonusImg.src=BONUS_SRC;

/* ================== DAY/NIGHT BACKGROUND ================== */
/* 4 fase, start dari SIANG (noon) */
const PHASE_MS = 16000;
const DAY_MS   = PHASE_MS * 4;
const BG_PARALLAX = 0.15;
const START_AT_NOON = 0.00; // 0..1

/* palet top/bottom tiap fase (SIANG‚ÜíSORE‚ÜíMALAM‚ÜíSUBUH) */
const SKY_PHASE = [
  { top:'#74c8ff', bot:'#c9ecff' },        // SIANG ‚Äì biru cerah
  { top:'#ff9b5e', bot:'#ffd39a' },        // SORE  ‚Äì jingga
  { top:'#070b16', bot:'#0f172a' },        // MALAM ‚Äì hitam kebiruan
  { top:'#0a0f1e', bot:'#1a2b4e' },        // SUBUH ‚Äì hitam ‚Üí kebiruan
];
const DUSK_TINT  = { top:'#ffb07a', bot:'#ffd7a1' }; // warm
const DAWN_TINT  = { top:'#244b9a', bot:'#3e74c9' }; // cool biru subuh

let cloudOffset1=0, cloudOffset2=0;
let dayClock = START_AT_NOON * DAY_MS;
let bgTLast = performance.now();
let brightness = 1; // 0..1

const STARS = Array.from({length:120},()=>({x:Math.random(), y:Math.random()*0.6, tw:0.6+Math.random()*0.5}));

function drawSky(top,bottom){const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,top);g.addColorStop(1,bottom);ctx.fillStyle=g;ctx.fillRect(0,0,W,H);}

function drawClouds(off1,off2,alpha){
  ctx.save(); ctx.globalAlpha = alpha;
  const cloud=(x,y,s)=>{
    ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,0.92)';
    ctx.arc(x,y,s,0,Math.PI*2);
    ctx.arc(x+s*0.8,y+s*0.2,s*0.9,0,Math.PI*2);
    ctx.arc(x-s*0.7,y+s*0.25,s*0.75,0,Math.PI*2);
    ctx.fill();
  };
  const baseY1=H*0.18, baseY2=H*0.28;
  for(let i=-1;i<=4;i++){ cloud((i*0.35*W)+(off1%W), baseY1, Math.min(W,H)*0.07); }
  ctx.globalAlpha = alpha*0.85;
  for(let i=-1;i<=4;i++){ cloud((i*0.50*W)+(off2%W), baseY2, Math.min(W,H)*0.055); }
  ctx.restore();
}

function drawSun(x,y,a){
  const R=Math.min(W,H)*0.08;
  ctx.save(); ctx.globalAlpha=a;
  ctx.fillStyle='#FFD166';
  ctx.beginPath(); ctx.arc(x,y,R,0,Math.PI*2); ctx.fill();
  const g=ctx.createRadialGradient(x,y,R*0.2,x,y,R*1.6);
  g.addColorStop(0,'rgba(255,209,102,0.75)');
  g.addColorStop(1,'rgba(255,209,102,0)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,R*1.6,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

/* bulan sabit natural */
function drawMoonCrescent(x,y,a, thin=0.62, tilt=-0.18){
  const R = Math.min(W,H)*0.06;
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(tilt);

  // group alpha
  ctx.globalAlpha = a;

  // 1) disk bulan
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = '#EFF3FA';
  ctx.beginPath();
  ctx.arc(0, 0, R, 0, Math.PI*2);
  ctx.fill();

  // 2) "ukir" sisi gelap dengan ellipse offset (destination-out)
  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath();
  // offset sedikit ke kanan-atas, elips sedikit pipih ‚Üí bentuk sabit natural
  ctx.ellipse(R*0.55, -R*0.06, R*thin, R*thin*0.98, 0, 0, Math.PI*2);
  ctx.fill();

  // 3) glow halus di sisi terang
  ctx.globalCompositeOperation = 'lighter';
  const g = ctx.createRadialGradient(-R*0.15, 0, R*0.25, -R*0.15, 0, R*1.1);
  g.addColorStop(0, 'rgba(255,255,255,0.12)');
  g.addColorStop(1, 'rgba(255,255,255,0)');
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(-R*0.15, 0, R*1.1, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();
}

let ridgeOff1=0, ridgeOff2=0, grassOff=0;
function drawMountainsAndGrass(dt){
  ridgeOff1 += dt*12; ridgeOff2 += dt*6; grassOff += dt*20;

  const farCol  = mixColor('#1c273a','#0e1524', 1-brightness);
  const nearCol = mixColor('#2c574f','#152a2c', 1-brightness);

  ctx.save();
  ctx.fillStyle = farCol;
  ctx.beginPath(); ctx.moveTo(0,H*0.72);
  for(let x=0;x<=W;x+=14){
    const y = H*0.72 - 28*Math.sin((x+ridgeOff2)*0.004) - 18*Math.cos((x+ridgeOff2)*0.007);
    ctx.lineTo(x,y);
  }
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fill();

  ctx.fillStyle = nearCol;
  ctx.beginPath(); ctx.moveTo(0,H*0.80);
  for(let x=0;x<=W;x+=10){
    const y = H*0.80 - 36*Math.sin((x+ridgeOff1)*0.006) - 20*Math.cos((x+ridgeOff1)*0.010);
    ctx.lineTo(x,y);
  }
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fill();
  ctx.restore();

  // rumput
  ctx.save();
  const g=ctx.createLinearGradient(0,H*0.82,0,H);
  g.addColorStop(0, mixColor('#67c941','#2a7f2e', 1-brightness));
  g.addColorStop(1, mixColor('#3fae34','#175c24', 1-brightness));
  ctx.fillStyle=g;
  ctx.beginPath(); ctx.moveTo(0,H*0.88);
  for(let x=0;x<=W;x+=8){
    const y = H*0.88 + 12*Math.sin((x+grassOff)*0.004);
    ctx.lineTo(x,y);
  }
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fill();

  ctx.globalAlpha = 0.14*(0.55 + 0.45*brightness);
  ctx.strokeStyle='#ffffff'; ctx.lineWidth=1;
  for(let x=6;x<W;x+=12){
    const y = H*0.88 + 12*Math.sin((x+grassOff)*0.004);
    const len = 3 + ((x%24)<12?1:0);
    ctx.beginPath(); ctx.moveTo(x,y+3); ctx.lineTo(x,y-len); ctx.stroke();
  }
  ctx.restore();
}

function drawStars(alpha){
  ctx.save(); ctx.fillStyle='#e8eefc';
  for(const s of STARS){
    const tw=0.6 + Math.sin(performance.now()/400 * s.tw)*0.4;
    ctx.globalAlpha = alpha*tw;
    ctx.fillRect(s.x*W, s.y*H, 1.5, 1.5);
  }
  ctx.restore();
}

// === SATU-SATUNYA renderBackground() (tempel menimpa yang ada) ===
function renderBackground(){
  // waktu siklus
  const now = performance.now();
  const dt  = Math.min(0.05,(now-bgTLast)/1000);
  bgTLast   = now;
  dayClock  = (dayClock + dt*1000) % DAY_MS;

  // progress 0..1
  const prog = (dayClock % DAY_MS) / DAY_MS;

  // orbit elips
  const cx=W*0.5, cy=H*0.62;
  const rx=W*0.42, ry=H*0.36;
  const angle = (prog*2*Math.PI) - Math.PI/2;
  const sunX  = cx + Math.cos(angle)*rx;
  const sunY  = cy - Math.sin(angle)*ry;

  // --- ketinggian matahari ---
  const rawElev   = (cy - sunY)/(H*0.45);       // <0 = di bawah horizon, >0 = di atas
  const elevNorm  = clamp(rawElev, 0, 1);       // 0..1 hanya saat di atas
  const daylight  = smooth01(elevNorm);         // easing
  const sunriseBoost = remapSmooth(rawElev, -0.14, 0.08) * 0.40; // bantu subuh cepat terang
  brightness = clamp(daylight + sunriseBoost, 0, 1);

  // --- warna langit murni dari brightness ---
  const nightTop='#0a0f1e', nightBot='#121a2c';
  const dayTop  ='#74c8ff', dayBot  ='#c9ecff';
  let skyTop = mixColor(nightTop, dayTop, brightness);
  let skyBot = mixColor(nightBot, dayBot, brightness);

  // tint horizon: hangat saat sunset, biru saat subuh
  const horizonProx = clamp(1 - Math.abs((cy - sunY)/(H*0.16)), 0, 1);
  const warmT = horizonProx * clamp(rawElev,  0, 1) * 0.65;  // sore
  const dawnT = horizonProx * clamp(-rawElev, 0, 1) * 0.85;  // subuh
  skyTop = mixColor(skyTop, DUSK_TINT.top, warmT);
  skyBot = mixColor(skyBot, DUSK_TINT.bot, warmT);
  skyTop = mixColor(skyTop, DAWN_TINT.top, dawnT);
  skyBot = mixColor(skyBot, DAWN_TINT.bot, dawnT);

  // gambar langit
  drawSky(skyTop, skyBot);

  // bintang: padam cepat saat matahari naik
  const starAlpha = 1 - remapSmooth(rawElev, -0.10, 0.02);
  if (starAlpha>0.02) drawStars(starAlpha);

  // awan lebih tebal saat terang
  const cloudA = 0.20 + 0.75*brightness;
  drawClouds(cloudOffset1, cloudOffset2, cloudA);

  // matahari / bulan (cross-fade)
  const sunAlpha  = remapSmooth(rawElev, 0.02, 0.14);
  const moonAlpha = 1 - remapSmooth(rawElev, -0.06, 0.10);
  if (sunAlpha>0.01)  drawSun(sunX, sunY, sunAlpha);
  if (moonAlpha>0.01){
    const moonX = cx + Math.cos(angle+Math.PI)*rx;
    const moonY = cy - Math.sin(angle+Math.PI)*ry;
    drawMoonCrescent(moonX, moonY, moonAlpha, 0.62, -0.18);
  }

  // landscape mengikuti brightness
  drawMountainsAndGrass(dt);

  // kontras skor
  scoreEl.style.color = (brightness < 0.55) ? '#fff' : '#0b1222';
  scoreEl.style.textShadow = (brightness < 0.55)
    ? '0 1px 2px rgba(0,0,0,.6)'
    : '0 1px 2px rgba(255,255,255,.25)';

  // (opsional) update monitor debug jika ada
  if (window.__sky){ window.__sky.rawElev = rawElev; window.__sky.brightness = brightness; }
}
 
/* ================== OBSTACLES & GAMEPLAY ================== */
const PIPE={width:Math.max(80,(W*0.08)|0), gapBase:Math.max(160,(H*0.28)|0), spawnMin:Math.max(240,(W*0.36)|0), spawnMax:Math.max(280,(W*0.42)|0)};
const BONUS={ sizeBase: Math.max(34,(Math.min(W,H)*0.1)|0), rotateSpeed:2.0, chance:0.65, yOffset:20 };

function needPipe(){ if(!pipes.length) return true; const last=pipes[pipes.length-1]; return (W-last.x) >= rand(PIPE.spawnMin,PIPE.spawnMax); }
function spawnPipe(){ const gap=PIPE.gapBase, top=rand(50, Math.max(50,H-gap-120)); const p={x:W+10,y:top,width:PIPE.width,gap,passed:false}; pipes.push(p); if(Math.random()<BONUS.chance) spawnBonusAtPipe(p); }
function spawnBonusAtPipe(p){ const mid=p.y+p.gap/2; const y=clamp(mid+(Math.random()-0.5)*2*BONUS.yOffset,p.y+20,p.y+p.gap-20); bonuses.push({x:p.x+PIPE.width+120,y,size:BONUS.sizeBase,angle:0}); }

/* ================== INPUT & LOOP ================== */
function flap(){ if(state.running){ player.vy=state.flapVel; } }
canvas.addEventListener('mousedown',flap);
canvas.addEventListener('touchstart',e=>{e.preventDefault();flap();},{passive:false});
addEventListener('keydown',e=>{
  if(e.code==='Space'){ e.preventDefault(); flap(); }
  if(e.key==='c'||e.key==='C'){ state.charIndex=(state.charIndex+1)%charImgs.length; player.sprite=charImgs[state.charIndex];}
});
btnStart.addEventListener('click',()=>{ if(validateName()) startGame(); });
btnLb.addEventListener('click',openLeaderboard);

function startGame(){
  localStorage.setItem('lamumu_name', nameInput.value.trim());
  const sel=document.querySelector('input[name="char"]:checked'); state.charIndex=sel?+sel.value:0;
  player.sprite=charImgs[state.charIndex];
  state.running=true; state.score=0; state.time=0; state.pipesPassed=0; state.speed=state.speedBase;
  player.x=Math.max(80,(W*0.18)|0); player.y=(H*0.45)|0; player.vy=0;
  pipes.length=0; bonuses.length=0;
  overlay.style.display='none';
}

let last=performance.now();
function loop(now){
  const dt=Math.min(0.033,(now-last)/1000); last=now;
  if(state.running) update(dt);
  draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt){
  state.time+=dt;
  state.speed=Math.min(state.speedMax, state.speedBase + state.pipesPassed*state.speedPerPipe);

  if(needPipe()) spawnPipe();

  for(let i=pipes.length-1;i>=0;i--){
    const p=pipes[i]; p.x -= state.speed*dt;
    if(p.x + p.width < -10) pipes.splice(i,1);
    if(!p.passed && p.x + p.width < player.x){ p.passed=true; state.pipesPassed++; state.score += 1; }
  }

  player.vy += state.gravity*dt; player.y += player.vy*dt;

  for(const p of pipes){
    if(circleRect(player.x,player.y,player.r, p.x,0,p.width,p.y) ||
       circleRect(player.x,player.y,player.r, p.x,p.y+p.gap,p.width,H-(p.y+p.gap))){ return gameOver(); }
  }
  if(player.y>H-2 || player.y<-20) return gameOver();

  for(let i=bonuses.length-1;i>=0;i--){
    const b=bonuses[i]; b.x -= state.speed*dt; b.angle += BONUS.rotateSpeed*dt;
    if(dist(player.x,player.y,b.x,b.y) < (player.r + b.size*0.5*0.8)){ state.score += 100; bonuses.splice(i,1); continue; }
    if(b.x < -80) bonuses.splice(i,1);
  }

  scoreEl.textContent='Score: '+state.score;

  // parallax awan
  cloudOffset1 = (cloudOffset1 + state.speed * BG_PARALLAX * 0.50 * dt) % W;
  cloudOffset2 = (cloudOffset2 + state.speed * BG_PARALLAX * 0.25 * dt) % W;
}

function draw(){
  ctx.clearRect(0,0,W,H);
  renderBackground();

  // PIPES
  ctx.fillStyle='#1f4fd1';
  for(const p of pipes){
    ctx.fillRect(p.x,0,p.width,p.y);
    ctx.fillRect(p.x,p.y+p.gap,p.width,H-(p.y+p.gap));
  }

  // BONUS
  for(const b of bonuses){
    ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.angle);
    const s=b.size; if(bonusImg.complete && bonusImg.naturalWidth) ctx.drawImage(bonusImg,-s/2,-s/2,s,s);
    else { ctx.fillStyle='#ff3b3b'; ctx.beginPath(); ctx.arc(0,0,s/2,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }

  // PLAYER
  if(state.running){
    const s=player.r*2.2*1.15;
    if(player.sprite && player.sprite.complete && player.sprite.naturalWidth){
      ctx.drawImage(player.sprite, player.x-s/2, player.y-s/2, s, s);
    }else{
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.stroke();
    }
  }
}

/* ================== HELPERS & UI ================== */
function circleRect(cx,cy,cr, rx,ry,rw,rh){
  const tx=Math.max(rx,Math.min(cx,rx+rw)), ty=Math.max(ry,Math.min(cy,ry+rh));
  const dx=cx-tx, dy=cy-ty; return dx*dx+dy*dy <= cr*cr;
}
function dist(x1,y1,x2,y2){ const dx=x1-x2, dy=y1-y2; return Math.hypot(dx,dy); }
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* drag-to-scroll karakter */
const charRow=document.getElementById('charRow');
let isDown=false,startX=0,startLeft=0,dragged=false;
const onDown=x=>{isDown=true;dragged=false;startX=x;startLeft=charRow.scrollLeft;};
const onMove=x=>{if(!isDown)return;const dx=x-startX;if(Math.abs(dx)>5)dragged=true;charRow.scrollLeft=startLeft-dx;};
const onUp=()=>{isDown=false;if(dragged){const radios=charRow.querySelectorAll('input[type="radio"]');radios.forEach(r=>{r.addEventListener('click',e=>{e.stopPropagation();e.preventDefault();},{once:true,capture:true});});}};
charRow.addEventListener('mousedown',e=>onDown(e.pageX));
window.addEventListener('mousemove',e=>onMove(e.pageX));
window.addEventListener('mouseup',onUp);
charRow.addEventListener('touchstart',e=>onDown(e.touches[0].pageX),{passive:true});
charRow.addEventListener('touchmove',e=>onMove(e.touches[0].pageX),{passive:true});
charRow.addEventListener('touchend',onUp);

/* BGM unlock */
const bgm=document.getElementById('bgm');
if(bgm){
  bgm.volume=0.35; let started=false;
  function unlockBgm(){ if(!started){ bgm.play().then(()=>{started=true}).catch(()=>{}); } }
  window.addEventListener('touchstart',unlockBgm,{once:true,passive:true});
  window.addEventListener('mousedown',unlockBgm,{once:true,passive:true});
  window.addEventListener('keydown',unlockBgm,{once:true,passive:true});
}

/* Leaderboard */
async function gameOver(){
  state.running=false; overlay.style.display='flex'; validateName();
  try{ const moo=document.getElementById('moo'); if(moo){ moo.currentTime=0; await moo.play(); } }catch(_){}
  try{ await saveScore((nameInput.value||'').trim(), state.score); }catch(e){ /* ignore */ }
  openLeaderboard();
}
async function saveScore(name, score){
  try{
    if(!name || name.length<3) return;
    await fetch('/api/leaderboard/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,score})});
  }catch(_){}
}
async function openLeaderboard(){
  lbPanel.style.display='block';
  lbList.innerHTML='<div class="muted" style="padding:10px">Loading‚Ä¶</div>';
  try{
    const res=await fetch('/api/leaderboard/top?limit=100');
    const data=await res.json();
    const items=(Array.isArray(data&&data.items)?data.items:data||[]).filter(it=>Number(it.score||0)>0);
    renderLeaderboard(items);
  }catch(_){
    lbList.innerHTML='<div class="muted" style="padding:10px">Cannot load leaderboard.</div>';
  }
}
function renderLeaderboard(items){
  if(!items||!items.length){ lbList.innerHTML='<div class="muted" style="padding:10px">No scores yet.</div>'; return; }
  const rows=items.map((it,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(it.name||'anonymous')}</td><td>${Number(it.score||0)}</td></tr>`).join('');
  lbList.innerHTML=`<table><thead><tr><th>#</th><th>Name</th><th>Score</th></tr></thead><tbody>${rows}</tbody></table>`;
}
})();
</script>
</body>
</html>
