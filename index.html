<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Flappy Lamumu</title>
<style>
/* ===== Fix mobile panel & character picker ===== */
#startPanel{
  width:min(680px,92vw);
  max-width:92vw;
  overflow:hidden;              /* jaga rounded tidak ‚Äúbocor‚Äù */
}

/* grid default (desktop/tablet) */
.row{ display:grid; gap:12px; }
.grid-4{ grid-template-columns:repeat(4, minmax(0,1fr)); justify-items:center; }
.card{ width:100%; }

/* HP ‚â§ 480px: 2 kolom agar tidak kepotong */
@media (max-width: 480px){
  .grid-4{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  #startPanel{ padding:18px 14px; }
  #startPanel h2{ font-size:20px; }
  #startPanel .card img{ width:64px; height:64px; }
  #startPanel .card div:last-child input[type="radio"]{ transform:scale(1.15); }
  input[type="text"]{ font-size:16px; } /* cegah zoom iOS saat fokus */
}

/* Layar sangat kecil (‚â§ 340px): fallback 1 kolom */
@media (max-width: 340px){
  .grid-4{ grid-template-columns: 1fr; }
}

/* Opsi tambahan: kalau tetap sempit, aktifkan scroll horizontal yang smooth.
   Matikan baris di atas dan gunakan block ini sebagai alternatif. */
/*
@media (max-width: 480px){
  .grid-4{
    display:grid;
    grid-auto-flow: column;
    grid-auto-columns: calc(50% - 8px);  /* 2 kartu per ‚Äúhalaman‚Äù */
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    padding-bottom: 6px;
  }
  .grid-4 > *{ scroll-snap-align: start; }
}
*/
/* ====== Mobile-safe layout for Start Panel & Leaderboard ====== */
#startPanel{
  width:min(680px,92vw);
  max-width:92vw;
}

/* Kontainer leaderboard: selalu muat & bisa scroll */
#lbPanel{ margin-top:14px; }
#lbList{
  max-height:240px;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#fff;
}

/* Tabel: kolom stabil & tidak ‚Äúgeser‚Äù di HP */
#lbList table{
  width:100%;
  min-width:320px;          /* biar tidak mepet di HP kecil */
  border-collapse:collapse;
  table-layout:fixed;       /* kunci lebar kolom */
  font-size:14px;
}
#lbList thead th{
  position:sticky; top:0;
  background:#f8fafc;
  border-bottom:1px solid #f1f5f9;
  padding:10px;
  text-align:left;
  font-weight:600;
}
#lbList tbody td{
  padding:10px;
  border-bottom:1px solid #f3f4f6;
}
#lbList .col-rank{
  width:48px;
  text-align:center;
}
#lbList .col-score{
  width:96px;
  text-align:right;
  font-variant-numeric:tabular-nums;
  font-feature-settings:"tnum" 1,"lnum" 1;
}

/* Rapikan input & kartu karakter di layar kecil */
@media (max-width:480px){
  #startPanel{ padding:18px 14px; }
  #startPanel h2{ font-size:20px; }
  #startPanel .card img{ width:64px; height:64px; }
  #startPanel .card div:last-child input[type="radio"]{ transform:scale(1.15); }
  input[type="text"]{ font-size:16px; } /* menghindari zoom iOS */
}
  /* penting agar input tidak melebar keluar panel */
  *,*::before,*::after{ box-sizing:border-box }

  :root{ --ui-bg:rgba(255,255,255,.96); --ui-radius:18px; --brand:#2563eb; }
  html,body{height:100%;margin:0}
  body{background:#6b8f99;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow:hidden}
  #wrap{position:fixed;inset:0}
  #game{position:absolute;inset:0;display:block;background:linear-gradient(#cfefff,#bde6fd)}
  #score{position:absolute;top:8px;left:50%;transform:translateX(-50%);font-weight:700;font-size:16px;pointer-events:none}

  /* overlay & start panel */
  #overlay{position:absolute;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:8}
  #startPanel{
    width:min(680px,92vw);background:var(--ui-bg);backdrop-filter:saturate(1.2) blur(8px);
    border-radius:var(--ui-radius);box-shadow:0 20px 60px rgba(0,0,0,.35);padding:22px 20px;z-index:9;
    text-align:center;
  }
  #startPanel h2{margin:6px 0 8px;font-size:22px}
  .muted{color:#4b5563;font-size:12px}

  .row{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr);justify-items:center}

  .card{border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px 12px;text-align:center;background:#fff;width:100%}
  .card img{width:72px;height:72px;object-fit:contain;display:block;margin:4px auto 8px}

  /* Sembunyikan teks "Lamumu #n" dan "Use #n" -> hanya tampil bulatan radio */
  #startPanel .card .muted{display:none!important}
  #startPanel .card div:last-child{font-size:0;line-height:1}
  #startPanel .card div:last-child input[type="radio"]{transform:scale(1.35);vertical-align:middle}

  .actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
  .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:600;background:#e5e7eb;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff}
  .btn[disabled]{opacity:.45;cursor:not-allowed}

  input[type="text"]{
    width:100%;max-width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:14px
  }
  input[type="text"].invalid{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.15)}
  #nameErr{display:none;color:#ef4444;font-size:12px;margin-top:6px}

  /* Leaderboard table layout */
  #lbPanel h3{font-size:16px;margin:0 0 8px}
  #lbList table{width:100%;border-collapse:collapse;font-size:14px}
  #lbList thead th{
    position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #f1f5f9;
    padding:8px 10px;text-align:left;font-weight:600
  }
  #lbList tbody td{padding:8px 10px;border-bottom:1px solid #f8fafc}
  #lbList .col-rank{width:52px}
  #lbList .col-score{
    width:100px;text-align:right;
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum" 1, "lnum" 1;
  }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>
  <div id="score">Score: 0</div>

  <!-- üîä AUDIO (disembunyikan) -->
  <audio id="bgm" src="assets/sweet-country-farm-music-full-354815.mp3" loop preload="auto"></audio>
  <audio id="moo" src="assets/cow-moo-390282.mp3" preload="auto"></audio>

  <div id="overlay">
    <div id="startPanel">
      <h2>Flappy Lamumu üêÆ</h2>
      <div class="muted">Tap / Click anywhere on the game to flap ¬∑ Press <b>C</b> to switch character quickly</div>

      <!-- input nama -->
      <div style="margin:12px 0 6px">
        <input id="playerName" type="text" placeholder="Enter your name (required for leaderboard)">
        <div id="nameErr">Please enter at least 3 characters.</div>
      </div>

      <div class="row grid-4" style="margin-top:10px">
        <label class="card">
          <img src="assets/lamumu1.png" alt="Lamumu 1">
          <div><input type="radio" name="char" value="0" checked></div>
        </label>
        <label class="card">
          <img src="assets/lamumu2.png" alt="Lamumu 2">
          <div><input type="radio" name="char" value="1"></div>
        </label>
        <label class="card">
          <img src="assets/lamumu3.png" alt="Lamumu 3">
          <div><input type="radio" name="char" value="2"></div>
        </label>
        <label class="card">
          <img src="assets/lamumu4.png" alt="Lamumu 4">
          <div><input type="radio" name="char" value="3"></div>
        </label>
      </div>

      <div class="actions">
        <button id="btnStart" class="btn primary" disabled>Start</button>
        <button id="btnLb" class="btn" type="button">Leaderboard</button>
      </div>
      <div class="muted" style="text-align:center;margin-top:6px">Tip: You can change character during play by pressing <b>C</b>.</div>
    </div>
  </div>
</div>

<script>
(() => {
  /* ====== GAME + LEADERBOARD + AUDIO ====== */

  const CHAR_SRCS = [
    'assets/lamumu1.png',
    'assets/lamumu2.png',
    'assets/lamumu3.png',
    'assets/lamumu4.png',
  ];
  const BONUS_SRC = 'assets/bonus.png';

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const overlay = document.getElementById('overlay');
  const btnStart = document.getElementById('btnStart');
  const nameInput = document.getElementById('playerName');
  const nameErr = document.getElementById('nameErr');

  // üîä Audio elements
  const bgm = document.getElementById('bgm');
  const moo = document.getElementById('moo');
  bgm.volume = 0.35;
  moo.volume = 0.7;

  // unlock audio on first interaction (mobile policy)
  function unlockAudioOnce(){
    [bgm, moo].forEach(a=>{
      if(!a) return;
      a.muted = false;
      a.play().then(()=>a.pause()).catch(()=>{});
    });
  }
  window.addEventListener('touchstart', unlockAudioOnce, { once:true, passive:true });
  window.addEventListener('mousedown',   unlockAudioOnce, { once:true, passive:true });
  window.addEventListener('keydown',     unlockAudioOnce, { once:true, passive:true });

  // === elemen leaderboard
  const startPanel = document.getElementById('startPanel');
  const btnLb = document.getElementById('btnLb');
  const lbPanel = document.createElement('div');
  lbPanel.id = 'lbPanel';
  lbPanel.style.marginTop = '14px';
  lbPanel.style.display = 'none';
  lbPanel.innerHTML = `
    <h3>Top 100 Leaderboard</h3>
    <div id="lbList" style="max-height:240px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff">
      <div class="muted" style="padding:10px">Loading‚Ä¶</div>
    </div>
  `;
  startPanel.appendChild(lbPanel);
  const lbList = lbPanel.querySelector('#lbList');

  // restore & validasi nama
  nameInput.value = localStorage.getItem('lamumu_name') || '';
  const MIN_NAME = 3;
  function validateName(){
    const ok = (nameInput.value.trim().length >= MIN_NAME);
    btnStart.disabled = !ok;
    nameInput.classList.toggle('invalid', !ok);
    nameErr.style.display = ok ? 'none' : 'block';
    return ok;
  }
  nameInput.addEventListener('input', validateName);
  nameInput.addEventListener('blur', validateName);
  validateName();

  // ukuran canvas
  let W=0,H=0,DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  function resize(){ W=innerWidth|0; H=innerHeight|0;
    canvas.width=(W*DPR)|0; canvas.height=(H*DPR)|0; canvas.style.width=W+'px'; canvas.style.height=H+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  addEventListener('resize',resize,{passive:true}); resize();

  // state
  const state = {
    running:false, score:0, time:0,
    speedBase:190, speedMax:420, speed:190,
    pipesPassed:0, speedPerPipe:2.2,
    gravity:900, flapVel:-400, charIndex:0,
  };

  const pipes=[];
  const PIPE = {
    width: Math.max(80,(W*0.08)|0),
    gapBase: Math.max(160,(H*0.28)|0),
    spawnMin: Math.max(240,(W*0.36)|0),
    spawnMax: Math.max(280,(W*0.42)|0)
  };

  const bonuses=[];
  const BONUS={ sizeBase: Math.max(34,(Math.min(W,H)*0.1)|0), rotateSpeed:2.0, chance:0.65, yOffset:20 };

  const player={ x:Math.max(80,(W*0.18)|0), y:(H*0.45)|0, vy:0, r:Math.max(22,(Math.min(W,H)*0.024)|0), sprite:null };

  const charImgs = CHAR_SRCS.map(s=>{const im=new Image(); im.src=s; return im;});
  const bonusImg = new Image(); bonusImg.src=BONUS_SRC;

  function flap(){ if(state.running){ player.vy=state.flapVel; } }
  canvas.addEventListener('mousedown',flap);
  canvas.addEventListener('touchstart',e=>{e.preventDefault();flap();},{passive:false});
  addEventListener('keydown',e=>{
    if(e.code==='Space'){ e.preventDefault(); flap(); }
    if(e.key==='c'||e.key==='C'){ state.charIndex=(state.charIndex+1)%charImgs.length; player.sprite=charImgs[state.charIndex];}
  });

  btnStart.addEventListener('click',() => { if (validateName()) startGame(); });
  btnLb.addEventListener('click', openLeaderboard);

  function startGame(){
    localStorage.setItem('lamumu_name', nameInput.value.trim());
    const sel=document.querySelector('input[name="char"]:checked'); state.charIndex=sel?+sel.value:0;
    player.sprite=charImgs[state.charIndex];
    state.running=true; state.score=0; state.time=0; state.pipesPassed=0; state.speed=state.speedBase;
    player.x=Math.max(80,(W*0.18)|0); player.y=(H*0.45)|0; player.vy=0;
    pipes.length=0; bonuses.length=0;
    overlay.style.display='none';
    // üîä mulai BGM
    try{ bgm.currentTime = 0; bgm.play(); }catch(e){}
  }

  const rand=(a,b)=>a+Math.random()*(b-a);
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  function needPipe(){ if(!pipes.length) return true; const last=pipes[pipes.length-1]; return (W-last.x) >= rand(PIPE.spawnMin,PIPE.spawnMax); }
  function spawnPipe(){
    const gap=PIPE.gapBase, top=rand(50, Math.max(50,H-gap-120));
    const p={x:W+10,y:top,width:PIPE.width,gap,passed:false}; pipes.push(p);
    if(Math.random()<BONUS.chance) spawnBonusAtPipe(p);
  }
  function spawnBonusAtPipe(p){
    const mid = p.y + p.gap/2;
    const y = clamp(mid + (Math.random()-0.5)*2*BONUS.yOffset, p.y+20, p.y+p.gap-20);
    bonuses.push({x:p.x + PIPE.width + 120, y, size:BONUS.sizeBase, angle:0});
  }

  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000); last=now;
    if(state.running) update(dt);
    draw(); requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function update(dt){
    state.time+=dt;
    state.speed = Math.min(state.speedMax, state.speedBase + state.pipesPassed*state.speedPerPipe);

    if(needPipe()) spawnPipe();

    for(let i=pipes.length-1;i>=0;i--){
      const p=pipes[i]; p.x -= state.speed*dt;
      if(p.x + p.width < -10) pipes.splice(i,1);
      if(!p.passed && p.x + p.width < player.x){ p.passed=true; state.pipesPassed++; state.score += 1; }
    }

    player.vy += state.gravity*dt; player.y += player.vy*dt;

    for(const p of pipes){
      if(circleRect(player.x,player.y,player.r, p.x,0,p.width,p.y) ||
         circleRect(player.x,player.y,player.r, p.x,p.y+p.gap,p.width,H-(p.y+p.gap))){ return gameOver(); }
    }
    if(player.y>H-2 || player.y<-20) return gameOver();

    for(let i=bonuses.length-1;i>=0;i--){
      const b=bonuses[i]; b.x -= state.speed*dt; b.angle += BONUS.rotateSpeed*dt;
      if(dist(player.x,player.y,b.x,b.y) < (player.r + b.size*0.5*0.8)){ state.score += 100; bonuses.splice(i,1); continue; }
      if(b.x < -80) bonuses.splice(i,1);
    }

    scoreEl.textContent='Score: '+state.score;
  }

  async function gameOver(){
    state.running=false;
    overlay.style.display='flex';
    validateName();

    // üîä SFX & hentikan BGM (hapus baris pause jika mau musik tetap jalan)
    try{ moo.currentTime = 0; moo.play(); }catch(e){}
    try{ bgm.pause(); }catch(e){}

    // simpan skor
    try{ await saveScore((nameInput.value||'').trim(), state.score); }catch(e){ console.warn(e); }

    // tampilkan leaderboard
    openLeaderboard();
  }

  // ====== SAVE SCORE & LEADERBOARD ======
  async function saveScore(name, score){
    if(!name || name.length<3) return;
    await fetch('/api/leaderboard/submit', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, score })
    });
  }

  async function openLeaderboard(){
    lbPanel.style.display='block';
    lbList.innerHTML = '<div class="muted" style="padding:10px">Loading‚Ä¶</div>';
    try{
      const res = await fetch('/api/leaderboard/top?limit=100');
      const data = await res.json();
      const items = (Array.isArray(data?.items) ? data.items : data)
        .filter(it => Number(it.score||0) > 0);
      renderLeaderboard(items);
    }catch(e){
      lbList.innerHTML = '<div class="muted" style="padding:10px">Cannot load leaderboard.</div>';
      console.warn('load leaderboard failed:', e);
    }
  }
function renderLeaderboard(items){
  if(!items || !items.length){
    lbList.innerHTML = '<div class="muted" style="padding:10px">No scores yet.</div>';
    return;
  }
  const rows = items.map((it,i)=>`
    <tr>
      <td class="col-rank">${i+1}</td>
      <td>${escapeHtml(it.name||'anonymous')}</td>
      <td class="col-score">${Number(it.score||0)}</td>
    </tr>
  `).join('');
  lbList.innerHTML = `
    <table class="lb-table">
      <thead>
        <tr>
          <th class="col-rank">#</th>
          <th>Name</th>
          <th class="col-score">Score</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

  // helpers
  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#1f4fd1';
    for(const p of pipes){ ctx.fillRect(p.x,0,p.width,p.y); ctx.fillRect(p.x,p.y+p.gap,p.width,H-(p.y+p.gap)); }
    for(const b of bonuses){
      ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.angle);
      const s=b.size; if(bonusImg.complete) ctx.drawImage(bonusImg,-s/2,-s/2,s,s);
      else { ctx.fillStyle='#ff3b3b'; ctx.beginPath(); ctx.arc(0,0,s/2,0,Math.PI*2); ctx.fill(); }
      ctx.restore();
    }
    if(state.running && player.sprite && player.sprite.complete){
      const s = player.r*2.2*1.15; ctx.drawImage(player.sprite, player.x-s/2, player.y-s/2, s, s);
    }
  }
  function circleRect(cx,cy,cr, rx,ry,rw,rh){
    const tx=Math.max(rx,Math.min(cx,rx+rw)), ty=Math.max(ry,Math.min(cy,ry+rh));
    const dx=cx-tx, dy=cy-ty; return dx*dx+dy*dy <= cr*cr;
  }
  function dist(x1,y1,x2,y2){ const dx=x1-x2, dy=y1-y2; return Math.hypot(dx,dy); }
  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
})();
</script>
</body>
</html>
