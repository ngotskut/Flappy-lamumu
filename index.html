<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Flappy Lamumu</title>
<style>
  :root {
    --bg: #6f8f95; /* outer page background */
    --panel: #ffffff;
    --text: #0f172a;
    --accent: #2563eb;
  }
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    overscroll-behavior: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  #gameWrap {
    position: fixed; inset: 0;
    display: grid; place-items: center;
  }
  canvas {
    width: 100vw; height: 100vh; display: block;
    background: linear-gradient(#bfefff,#ace4fb);
    touch-action: none; /* biar tap tidak scroll */
  }

  /* score */
  #hud {
    position: fixed; top: env(safe-area-inset-top, 8px);
    left: 0; right: 0;
    text-align: center; font-weight: 700;
    z-index: 5; pointer-events: none;
  }

  /* modal */
  .modal {
    position: fixed; inset: 0;
    display: grid; place-items: center;
    background: rgba(15,23,42,.28);
    z-index: 10;
  }
  .card {
    width: min(900px, 92vw);
    background: var(--panel);
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.25);
    padding: 20px;
  }
  .title { font-size: clamp(20px, 2.2vw, 28px); font-weight: 800; text-align:center; margin: 6px 0 2px; }
  .subtitle { text-align:center; color:#334155; margin-bottom: 16px; }

  .row { display: grid; gap: 16px; }
  @media (min-width: 700px) { .row.cols-4 { grid-template-columns: repeat(4,1fr); } }

  .char {
    border: 1px solid #e5e7eb; border-radius: 12px;
    padding: 12px; display:grid; gap:8px; place-items:center;
  }
  .char img { width: 90px; height: 90px; image-rendering: -webkit-optimize-contrast; }
  .char label { font-size: 14px; }
  .actions { display:flex; gap:10px; justify-content:center; margin-top: 14px; }
  button {
    appearance:none; border:0; border-radius: 999px;
    padding: 10px 16px; font-weight: 700; cursor: pointer;
    background: var(--accent); color:white;
    box-shadow: 0 8px 20px rgba(37,99,235,.35);
  }
  button.secondary {
    background: #e2e8f0; color:#0f172a; box-shadow: none;
  }
  input[type="text"] {
    width: min(520px, 92%); display:block; margin: 0 auto 12px;
    padding: 10px 12px; font-size: 16px;
    border: 1px solid #e5e7eb; border-radius: 10px; outline: none;
  }
  .muted { color:#64748b; font-size:13px; text-align:center; margin-top:-4px; }

  /* helper hidden */
  .hidden { display:none !important; }

  /* Safe notch space for iOS */
  .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
</style>
</head>
<body>
  <div id="hud">Score: <span id="score">0</span></div>

  <div id="gameWrap">
    <canvas id="game"></canvas>
  </div>

  <!-- Start Modal -->
  <div class="modal" id="startModal" aria-modal="true" role="dialog">
    <div class="card safe-bottom">
      <div class="title">Flappy Lamumu üêÆ</div>
      <div class="subtitle">Tap / Click anywhere to flap ‚Ä¢ Press <b>C</b> to switch character quickly</div>

      <input id="playerName" type="text" placeholder="Enter your name" autocomplete="name" />

      <div class="row cols-4" id="charGrid">
        <div class="char">
          <img src="/assets/Lamumu1.png" alt="Lamumu #1">
          <label><input type="radio" name="char" value="0" checked> Use #1</label>
        </div>
        <div class="char">
          <img src="/assets/Lamumu2.png" alt="Lamumu #2">
          <label><input type="radio" name="char" value="1"> Use #2</label>
        </div>
        <div class="char">
          <img src="/assets/Lamumu3.png" alt="Lamumu #3">
          <label><input type="radio" name="char" value="2"> Use #3</label>
        </div>
        <div class="char">
          <img src="/assets/Lamumu4.png" alt="Lamumu #4">
          <label><input type="radio" name="char" value="3"> Use #4</label>
        </div>
      </div>

      <div class="actions">
        <button id="startBtn">Start</button>
        <button class="secondary" id="howBtn">Leaderboard (coming soon)</button>
      </div>
      <div class="muted">Tip: You can change character during play by pressing <b>C</b>.</div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bgm" src="/assets/sweet-country-farm-music-full-354815.mp3" loop preload="auto"></audio>
  <audio id="sfxOver" src="/assets/cow-moo-390282.mp3" preload="auto"></audio>

<script>
(() => {
  // ----------------- CONFIG -----------------
  const ASSETS = {
    cows: [
      "/assets/Lamumu1.png",
      "/assets/Lamumu2.png",
      "/assets/Lamumu3.png",
      "/assets/Lamumu4.png",
    ],
    bonus: "/assets/bonus.png",
  };

  const GAME = {
    zoom: 1.4,                 // "kamera" lebih dekat (1.0 = default)
    baseWidth:  70,            // lebar pipa dasar (dikali zoom saat render)
    baseBird:   42,            // ukuran burung dasar (dikali zoom saat render)
    gravity:    0.27,          // gravitasi (lebih kecil = jatuh lebih lambat)
    flapPower:  5.0,           // kekuatan flap
    speedBase:  2.4,           // kecepatan horizontal awal
    speedMax:   5.2,           // kecepatan maksimal ketika sulit
    gapStart:   300,           // celah pipa awal (lebar)
    gapMin:     160,           // celah minimal saat sulit
    pipeSpacing: 280,          // jarak antar pipa (px)
    bonusEvery:  2,            // peluang muncul bonus (1 dari N spawn)
    bonusMargin: 20,           // margin aman dari tepi gap saat menaruh bonus
    safeTop:    100,           // batas aman spawn center gap dari atas
    safeBottom: 120,           // batas aman spawn center gap dari bawah
  };

  // ----------------- STATE -----------------
  const canvas = document.getElementById('game');
  const ctx     = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');

  let W = 0, H = 0;
  const resize = () => {
    W = canvas.width  = Math.floor(window.innerWidth);
    H = canvas.height = Math.floor(window.innerHeight);
  };
  resize();
  window.addEventListener('resize', resize);

  const images = {
    cows: [],
    bonus: null,
  };

  // Load images
  const loadImage = src => new Promise(res => { const i=new Image(); i.onload=()=>res(i); i.src=src; });
  Promise.all(ASSETS.cows.map(loadImage)).then(list => images.cows = list);
  loadImage(ASSETS.bonus).then(img => images.bonus = img);

  // Audio unlock (mobile autoplay policy)
  const bgm = document.getElementById('bgm');
  const sfxOver = document.getElementById('sfxOver');
  const unlockAudio = () => {
    [bgm, sfxOver].forEach(a => { try { a.muted=false; a.play().then(()=>a.pause()).catch(()=>{}); } catch(e){} });
    window.removeEventListener('touchstart', unlockAudio);
    window.removeEventListener('mousedown', unlockAudio);
    window.removeEventListener('keydown', unlockAudio);
  };
  window.addEventListener('touchstart', unlockAudio, {once:true});
  window.addEventListener('mousedown', unlockAudio, {once:true});
  window.addEventListener('keydown', unlockAudio, {once:true});

  // Game vars
  let running = false;
  let score = 0;
  let pipes = [];
  let bonus = null; // {x,y,r,rot}
  let speed = GAME.speedBase;
  let gap = GAME.gapStart;
  let selectedCow = 0;
  let playerName = '';

  const bird = {
    x: 0, y: 0, vy: 0,
    w: GAME.baseBird, h: GAME.baseBird,
  };

  const resetGame = () => {
    score = 0;
    speed = GAME.speedBase;
    gap   = GAME.gapStart;
    pipes = [];
    bonus = null;

    bird.w = GAME.baseBird * GAME.zoom;
    bird.h = GAME.baseBird * GAME.zoom;
    bird.x = Math.max(40, W*0.2);
    bird.y = H*0.35;
    bird.vy = 0;

    // spawn beberapa pipa di depan
    let x = W + 40;
    for (let i=0; i<4; i++) {
      pipes.push(spawnPipe(x));
      x += GAME.pipeSpacing;
    }
    scoreEl.textContent = '0';
  };

  function spawnPipe(x) {
    // pilih center gap dalam rentang aman
    const minCenter = GAME.safeTop + gap/2;
    const maxCenter = H - GAME.safeBottom - gap/2;
    const centerY = rand(minCenter, maxCenter);

    // peluang bonus
    let maybeBonus = null;
    if (Math.random() < 1 / GAME.bonusEvery) {
      // tempatkan bonus di dalam gap, dengan margin agar tidak terlalu mepet
      const offsetRange = (gap/2) - GAME.bonusMargin;
      const bonusOffsetY = rand(-offsetRange, offsetRange);
      const bonusY = centerY + bonusOffsetY;
      const bonusR = 18 * GAME.zoom; // radius tampilan
      maybeBonus = { x: x + GAME.pipeSpacing*0.5, y: bonusY, r: bonusR, rot: 0 };
    }

    return { x, centerY, gap, bonus: maybeBonus, passed:false };
  }

  // Difficulty grows with score
  function updateDifficulty() {
    // naikkan kecepatan sedikit per skor
    speed = clamp(GAME.speedBase + score * 0.03, GAME.speedBase, GAME.speedMax);
    // kecilkan gap perlahan
    gap   = clamp(GAME.gapStart - score * 1.4, GAME.gapMin, GAME.gapStart);
  }

  // Utils
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const rand  = (a,b) => a + Math.random()*(b-a);

  function flap() {
    bird.vy = -GAME.flapPower; // naik
  }

  function startGame() {
    resetGame();
    running = true;
    try { bgm.currentTime = 0; bgm.volume = 0.45; bgm.play().catch(()=>{}); } catch(e){}
  }

  function gameOver() {
    running = false;
    try { sfxOver.currentTime = 0; sfxOver.play().catch(()=>{}); } catch(e){}
    try { bgm.pause(); } catch(e){}
    // tampilkan modal lagi, simpan skor local
    document.getElementById('startModal').classList.remove('hidden');
  }

  // Input: tap/click anywhere or Space to flap; C to switch cow
  const onTap = e => {
    e.preventDefault();
    if (!running) return;
    flap();
  };
  document.addEventListener('pointerdown', onTap, {passive:false});
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); if(running) flap(); }
    if (e.code === 'KeyC') { // quick switch character
      selectedCow = (selectedCow + 1) % ASSETS.cows.length;
    }
  });

  // Start modal events (biar input bisa diketik dengan enak)
  const startBtn = document.getElementById('startBtn');
  startBtn.addEventListener('click', () => {
    playerName = (document.getElementById('playerName').value || '').trim();
    const radio = document.querySelector('input[name="char"]:checked');
    selectedCow = radio ? parseInt(radio.value,10) : 0;
    document.getElementById('startModal').classList.add('hidden');
    startGame();
  });

  // ----------------- LOOP -----------------
  let last = performance.now();
  function loop(now) {
    const dt = Math.min(40, now-last); // ms
    last = now;

    // Clear
    ctx.clearRect(0,0,W,H);

    // Gameplay
    if (running) {
      bird.vy += GAME.gravity;       // gravity
      bird.y  += bird.vy;

      // Pipes update
      for (let p of pipes) {
        p.x -= speed;

        // bonus attach & rotate
        if (p.bonus) {
          p.bonus.x -= speed;
          p.bonus.rot += 0.06; // spin
        }

        // score: ketika sudah melewati pipa (sekali)
        if (!p.passed && p.x + GAME.baseWidth*GAME.zoom < bird.x) {
          p.passed = true;
          score++;
          scoreEl.textContent = score;
          updateDifficulty();
        }
      }

      // Recycle front pipe
      if (pipes.length && pipes[0].x + GAME.baseWidth*GAME.zoom < -10) {
        const lastX = pipes[pipes.length-1].x;
        pipes.shift();
        const np = spawnPipe(lastX + GAME.pipeSpacing);
        pipes.push(np);
      }

      // Bonus collision (circle with bird bbox)
      for (let p of pipes) {
        if (p.bonus) {
          const b = p.bonus;
          if (circleRectIntersect(b.x, b.y, b.r, bird.x, bird.y, bird.w, bird.h)) {
            // collect
            score += 100;
            scoreEl.textContent = score;
            p.bonus = null;
            updateDifficulty(); // boleh percepat sedikit juga
          }
        }
      }

      // Collisions with pipes or ground / ceiling
      if (bird.y < -20 || bird.y + bird.h > H+20) {
        gameOver();
      } else {
        // check each pipe
        for (let p of pipes) {
          const pipeW = GAME.baseWidth * GAME.zoom;
          // rects
          const topRect = { x:p.x, y:0, w:pipeW, h:p.centerY - p.gap/2 };
          const botRect = { x:p.x, y:p.centerY + p.gap/2, w:pipeW, h:H - (p.centerY + p.gap/2) };
          if (rectIntersect(bird.x, bird.y, bird.w, bird.h, topRect.x, topRect.y, topRect.w, topRect.h) ||
              rectIntersect(bird.x, bird.y, bird.w, bird.h, botRect.x, botRect.y, botRect.w, botRect.h)) {
            gameOver();
            break;
          }
        }
      }
    }

    // Draw
    drawScene();

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function drawScene() {
    // background gradient already via CSS; here draw pipes, bonus, bird, etc.
    // Pipes
    ctx.fillStyle = "#2554cf";
    for (let p of pipes) {
      const pipeW = GAME.baseWidth * GAME.zoom;
      // top
      const topH = p.centerY - p.gap/2;
      ctx.fillRect(p.x, 0, pipeW, topH);
      // bottom
      const botY = p.centerY + p.gap/2;
      ctx.fillRect(p.x, botY, pipeW, H - botY);

      // Bonus
      if (p.bonus && images.bonus) {
        const b = p.bonus;
        const s = (b.r*2); // diameter as size
        ctx.save();
        ctx.translate(b.x, b.y);
        ctx.rotate(b.rot);
        ctx.drawImage(images.bonus, -s/2, -s/2, s, s);
        ctx.restore();
      }
    }

    // Bird
    const img = images.cows[selectedCow];
    if (img) {
      ctx.drawImage(img, bird.x, bird.y, bird.w, bird.h);
    } else {
      // fallback square
      ctx.fillStyle = "#111";
      ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
    }
  }

  // --------------- collisions ---------------
  function rectIntersect(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }
  function circleRectIntersect(cx, cy, cr, rx, ry, rw, rh) {
    // closest point on rect to circle
    const nearestX = clamp(cx, rx, rx+rw);
    const nearestY = clamp(cy, ry, ry+rh);
    const dx = cx - nearestX;
    const dy = cy - nearestY;
    return (dx*dx + dy*dy) <= cr*cr;
  }

  // --------------- accessibility: focus inputs OK ---------------
  // agar elemen input di modal bisa di-tap/ketik
  const startModal = document.getElementById('startModal');
  startModal.addEventListener('click', (e) => {
    // click-through disabled intentionally
  });

})();
</script>
</body>
</html>
